<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>議事録</title>
</head>
<body>
  <h1>議事録</h1>

  <div id="content"></div>

  <h2>メモを追加する</h2>

  <form id="form" action="/dummy" method="post">
    <p><input id="memo" type="text" name="memo" size="100" /></p>
    <p><input type="submit" /></p>
  </form>

  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script type="text/javascript">
    $(function() {
      function refresh() {
        var onError = function(jqXHR, textStatus, errorThrown) {
          alert('error');
        };
        var onSuccess = function(data, textStatus, jqXHR) {
          $('#content ul').remove();
          var ul = $('<ul/>');
          // var minutes, li;
          $.each(data, function(_, minutes) {
            var li = $('<li/>')
                        .text(memo['Memo'] + '(' + new Date(memo['CreatedAt']) + ')');
            li.appendTo(ul);
          });
          ul.appendTo('#content');
          setTimeout(refresh, 100000);
        };
        $.ajax({
          url: '/showMemo?minutes=' + minutes, type: 'get'
        }).success(onSuccess).error(onError);
      }
      refresh();
      var href = window.location.href;
      if (href.indexOf('?minutes=') < 0) {
        window.location.href = 'index.html'
        return;
      }
      minutes = href.split('?minutes=')[1];

      var submit = function(event) {
        var memo = $('#memo');
        if(!memo.val()) {
          memo.focus();
          return false;
        }
        var onError = function(jqXHR, textStatus, errorThrown) {
          alert('error');
        };
        var onSuccess = function(data, textStatus, jqXHR) {
          alert('success')
          memo.val('');
          // refresh();
        };
        $.ajax({
          url: '/postMemo', type: 'post', data: {memo:memo.val(), minutes:minutes}
        }).success(onSuccess).error(onError);
        return false;
      };
      $('#form').submit(submit);
    });
  </script>
</body>
</html>